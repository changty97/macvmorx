<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacVMOrx Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
            color: #333;
        }
        .container {
            max-width: 1200px;
        }
        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .status-online {
            color: #10b981; /* green-500 */
        }
        .status-offline {
            color: #ef4444; /* red-500 */
        }
        .status-provisioning {
            color: #f59e0b; /* amber-500 */
        }
        .status-running {
            color: #3b82f6; /* blue-500 */
        }
        .status-completed {
            color: #10b981; /* green-500 */
        }
        .status-failed, .status-cancelled, .status-skipped {
            color: #ef4444; /* red-500 */
        }
        .status-queued {
            color: #6b7280; /* gray-500 */
        }
        .status-unknown {
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">MacVMOrx Dashboard</h1>
            <nav class="flex items-center space-x-4">
                <button id="nodesTabBtn" class="tab-button px-4 py-2 text-gray-600 font-medium rounded-md hover:bg-gray-100 transition duration-150 ease-in-out active">Nodes</button>
                <button id="jobsTabBtn" class="tab-button px-4 py-2 text-gray-600 font-medium rounded-md hover:bg-gray-100 transition duration-150 ease-in-out">Jobs</button>
                <div class="flex items-center space-x-2">
                    <label for="refreshInterval" class="text-gray-600 text-sm">Refresh:</label>
                    <select id="refreshInterval" class="px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="5000">5s</option>
                        <option value="15000" selected>15s</option>
                        <option value="30000">30s</option>
                        <option value="60000">60s</option>
                    </select>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4">
        <!-- Nodes Tab Content -->
        <div id="nodesTabContent" class="tab-content">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Mac Mini Nodes Status</h2>
            <div id="nodesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Node cards will be injected here by JavaScript -->
                <p class="text-gray-500">Loading node data...</p>
            </div>
        </div>

        <!-- Jobs Tab Content -->
        <div id="jobsTabContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">GitHub Workflow Jobs</h2>
            <div class="card p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Runner Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Host (NodeID)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VM IP</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Run Time</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Labels</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Job rows will be injected here by JavaScript -->
                            <tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading job data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4 text-center text-sm">
        <p>&copy; 2025 MacVMOrx. All rights reserved.</p>
    </footer>

    <script>
        const nodesTabBtn = document.getElementById('nodesTabBtn');
        const jobsTabBtn = document.getElementById('jobsTabBtn');
        const nodesTabContent = document.getElementById('nodesTabContent');
        const jobsTabContent = document.getElementById('jobsTabContent');
        const nodesGrid = document.getElementById('nodesGrid');
        const jobsTableBody = document.getElementById('jobsTableBody');
        const refreshIntervalSelect = document.getElementById('refreshInterval');

        const ORCHESTRATOR_BASE_URL = 'http://localhost:8080';

        let activeTab = 'nodes';
        let refreshTimer;

        function showTab(tabName) {
            nodesTabBtn.classList.remove('active');
            jobsTabBtn.classList.remove('active');
            nodesTabContent.classList.add('hidden');
            jobsTabContent.classList.add('hidden');

            clearInterval(refreshTimer);

            if (tabName === 'nodes') {
                nodesTabBtn.classList.add('active');
                nodesTabContent.classList.remove('hidden');
                activeTab = 'nodes';
                fetchNodes();
            } else if (tabName === 'jobs') {
                jobsTabBtn.classList.add('active');
                jobsTabContent.classList.remove('hidden');
                activeTab = 'jobs';
                fetchJobs();
            }
            setRefreshInterval();
        }

        nodesTabBtn.addEventListener('click', () => showTab('nodes'));
        jobsTabBtn.addEventListener('click', () => showTab('jobs'));

        function setRefreshInterval() {
            const interval = parseInt(refreshIntervalSelect.value, 10);
            clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (activeTab === 'nodes') {
                    fetchNodes();
                } else if (activeTab === 'jobs') {
                    fetchJobs();
                }
            }, interval);
            console.log(`Refresh interval set to ${interval / 1000} seconds.`);
        }

        refreshIntervalSelect.addEventListener('change', setRefreshInterval);

        function formatDuration(seconds) {
            if (seconds === undefined || seconds === null) return 'N/A';
            const s = Math.floor(seconds % 60);
            const m = Math.floor((seconds / 60) % 60);
            const h = Math.floor(seconds / 3600);
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'online':
                case 'healthy':
                case 'completed':
                    return 'status-online';
                case 'offline':
                case 'failed':
                case 'cancelled':
                case 'skipped':
                    return 'status-offline';
                case 'provisioning':
                    return 'status-provisioning';
                case 'running':
                    return 'status-running';
                case 'queued':
                    return 'status-queued';
                default:
                    return 'status-unknown';
            }
        }

        async function fetchNodes() {
            nodesGrid.innerHTML = '<p class="text-gray-500">Loading node data...</p>';
            try {
                const url = `${ORCHESTRATOR_BASE_URL}/api/nodes`;
                console.log('Fetching nodes from:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const nodes = await response.json();
                nodesGrid.innerHTML = '';

                if (nodes.length === 0) {
                    nodesGrid.innerHTML = '<p class="text-gray-500">No nodes registered yet.</p>';
                    return;
                }

                nodes.forEach(node => {
                    const lastSeen = new Date(node.LastSeen);
                    const timeSinceLastSeen = node.IsOnline ? 'Just now' : formatDuration((Date.now() - lastSeen.getTime()) / 1000) + ' ago';
                    const statusClass = getStatusClass(node.IsOnline ? 'online' : 'offline');

                    // FIX: Ensure node.VMs is an array, even if undefined or null
                    const vms = node.VMs || [];
                    const vmList = vms.length > 0
                        ? vms.map(vm => `<li class="text-sm"><strong>VM ID:</strong> ${vm.VMID} (${vm.ImageName}) - ${vm.VMIPAddress} - ${formatDuration(vm.RuntimeSeconds)}</li>`).join('')
                        : '<li class="text-sm text-gray-500">No VMs running.</li>';

                    nodesGrid.innerHTML += `
                        <div class="card p-6 flex flex-col space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">${node.NodeID}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium ${statusClass}">${node.IsOnline ? 'Online' : 'Offline'}</span>
                                <span class="text-xs text-gray-500">(${timeSinceLastSeen})</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                                <p><strong>VMs:</strong> ${node.VMCount}</p>
                                <p><strong>CPU:</strong> ${node.CPUUsagePercent.toFixed(1)}%</p>
                                <p><strong>Memory:</strong> ${node.MemoryUsageGB.toFixed(1)} GB / ${node.TotalMemoryGB.toFixed(1)} GB</p>
                                <p><strong>Disk:</strong> ${node.DiskUsageGB.toFixed(1)} GB / ${node.TotalDiskGB.toFixed(1)} GB</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Running VMs:</p>
                                <ul class="list-disc list-inside text-gray-600">
                                    ${vmList}
                                </ul>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Cached Images:</p>
                                <ul class="list-disc list-inside text-gray-600">
                                    ${node.CachedImages.length > 0 ? node.CachedImages.map(img => `<li class="text-sm">${img}</li>`).join('') : '<li class="text-sm text-gray-500">No images cached.</li>'}
                                </ul>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error fetching nodes:', error);
                nodesGrid.innerHTML = '<p class="text-red-500">Failed to load node data. Please ensure the orchestrator is running and accessible at ' + ORCHESTRATOR_BASE_URL + '</p>';
            }
        }

        async function fetchJobs() {
            jobsTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Loading job data...</td></tr>';
            try {
                const url = `${ORCHESTRATOR_BASE_URL}/api/jobs`;
                console.log('Fetching jobs from:', url);
                const response = await fetch(url);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const jobs = await response.json();
                jobsTableBody.innerHTML = '';

                if (jobs.length === 0) {
                    jobsTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">No GitHub jobs tracked yet.</td></tr>';
                    return;
                }

                jobs.sort((a, b) => new Date(b.QueueTime) - new Date(a.QueueTime));

                jobs.forEach(job => {
                    let runtime = 'N/A';
                    if (job.VMStartTime) {
                        const start = new Date(job.VMStartTime);
                        const end = job.EndTime ? new Date(job.EndTime) : new Date();
                        runtime = formatDuration((end.getTime() - start.getTime()) / 1000);
                    } else if (job.ProvisioningStartTime) {
                         const start = new Date(job.ProvisioningStartTime);
                         const end = job.EndTime ? new Date(job.EndTime) : new Date();
                         runtime = formatDuration((end.getTime() - start.getTime()) / 1000);
                    }

                    const statusClass = getStatusClass(job.Status);
                    const labels = job.Labels && job.Labels.length > 0 ? job.Labels.join(', ') : 'None';

                    jobsTableBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${job.JobID}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${job.RunnerName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.ImageName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${job.Status.charAt(0).toUpperCase() + job.Status.slice(1)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.NodeID || 'Pending'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.VMIPAddress || 'Pending'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${runtime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${labels}</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error fetching jobs:', error);
                jobsTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-500">Failed to load job data. Please ensure the orchestrator is running and accessible at ' + ORCHESTRATOR_BASE_URL + '</td></tr>';
            }
        }

        // Initial load based on active tab
        showTab(activeTab);

        // Set initial refresh interval based on default selected value
        setRefreshInterval();
    </script>
</body>
</html>
